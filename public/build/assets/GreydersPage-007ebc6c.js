import{d as Y,s as K,g as f,x as R,y as Q,j as T,c as g,a,t as M,u as v,f as c,n as N,e as C,r as G,z as X,o as x,A as E,i as F,b as z,w as V,m as U,B as L,C as Z,F as ee,k as te,D as J,h as ae,v as ne}from"./app-41c112f1.js";import{h as w,W as P}from"./Wialon-f86d8eb2.js";import{g as A,d as oe,a as se}from"./TimezoneDate-6d79c099.js";import{D as W,a as y,o as I,b as O}from"./data-grid-886eb247.js";import{L as le,_ as ie}from"./PreLoader.vue_vue_type_script_setup_true_lang-a82be481.js";import"./_commonjsHelpers-de833af9.js";const re={class:"relative"},ue={key:0},de={key:1},ce={key:0,class:"absolute inset-0 bg-black/40 z-50 flex justify-center items-center"},ve={class:"bg-white p-4 text-center rounded"},me=a("h3",{class:"mb-4 font-semibold"},"Выберите смену",-1),_e=a("span",{class:"mr-4"},null,-1),q=Y({__name:"PeriodPicker",props:{day:{},dayModifiers:{},smena:{},smenaModifiers:{}},emits:K(["submit"],["update:day","update:smena"]),setup(k,{emit:b}){const r=b,m=f(!1),d=f(null),_=f(null),i=R(k,"day"),p=R(k,"smena"),l=f([{start:new Date(new Date().getTime()+24*60*60*1e3),end:null}]);function n(){d.value=null,_.value=null}const e=f([{key:"today",highlight:!0,dates:i}]);return Q(()=>_.value,()=>{d.value==null||_.value==null||(i.value=d.value,p.value=_.value,m.value=!1,r("submit"))}),(o,t)=>{const s=G("VDatePicker"),u=X("click-outside");return T((x(),g("main",re,[a("button",{onClick:t[0]||(t[0]=h=>m.value=!0),class:"px-4 py-1.5 bg-slate-900 text-white rounded shadow-md"},[i.value==null&&p.value==null?(x(),g("span",ue," Выберите Дату ")):(x(),g("span",de,M(v(w)(i.value).format("YYYY-MM-DD"))+" СМЕНА : "+M(p.value),1))]),m.value?(x(),g("div",{key:0,onVnodeMounted:n,class:"absolute bg-white z-50 top-11 left-0"},[c(s,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=h=>d.value=h),mode:"date",attributes:e.value,"disabled-dates":l.value},null,8,["modelValue","attributes","disabled-dates"]),d.value?(x(),g("main",ce,[a("aside",ve,[me,a("button",{class:N([{"bg-slate-900 !text-white":_.value==1},"bg-gray-200 text-black w-10 h-10 rounded shadow-sm"]),onClick:t[2]||(t[2]=h=>_.value=1)},"1",2),_e,a("button",{class:N([{"bg-slate-900 !text-white":_.value==2},"bg-gray-200 text-black w-10 h-10 rounded shadow-sm"]),onClick:t[3]||(t[3]=h=>_.value=2)},"2",2)])])):C("",!0)],512)):C("",!0)])),[[u,()=>m.value=!1]])}}}),pe={class:"flex justify-end items-center px-2 bg-slate-900 text-white"},fe=a("i",{class:"fa-regular fa-xmark"},null,-1),xe=[fe],ye={class:"flex-grow relative"},be={class:"absolute inset-0 overflow-y-auto"},ge={class:"flex pt-2 px-2 items-start"},we={key:0,style:{color:"red"}},he={key:1,style:{color:"green"}},$e={class:"absolute bottom-0 w-full bg-gray-100 px-2 py-1.5 text-xl uppercase"},ke=a("br",null,null,-1),De=Y({__name:"GrayderModal",setup(k){const b=f(),r=f([]),m=f(null),d=f(null);b.value=new P;const _=A();m.value=_.date,d.value=_.smena;async function i(){r.value=[];const n=w(m.value).format("YYYY-MM-DD"),e=d.value==1?{start:"08:30",end:"09:40"}:{start:"20:30",end:"21:40"},o=await b.value.greyderTable(10587,w(`${n} ${e.start}`).unix(),w(`${n} ${e.end}`).unix());for(const s in o){const u=[...o[s].counts];var t="";u.forEach(h=>{t+=`${h.replace("РВ Экскаватор","")} `}),r.value.push({name:s,in_excavator:(o[s].time_in_excavator/60).toFixed(1),counts:o[s].counts.size,excavator_names:t,active:o[s].in_not_excavator_move==0&&o[s].in_not_excavator_stop==0&&o[s].time_in_excavator==0,in_smena:d.value==1?"08:30 - 09:40 | 70 мин":"20:30 - 21:40 | 70 мин",in_not_excavator_move:(o[s].in_not_excavator_move/60).toFixed(1),in_not_excavator_stop:(o[s].in_not_excavator_stop/60).toFixed(1),excavator_move:o[s].in_not_excavator_move,excavator_stop:o[s].in_not_excavator_stop,excalibur:o[s].time_in_excavator})}}const p=E(()=>{const n=r.value.reduce((o,t)=>t.active==!1?o+=1:o,0),e=r.value.reduce((o,t)=>t.count!=0?o+=t.counts:o,0);return(e+n==0?0:e/n).toFixed(1)}),l=E(()=>{const e=r.value.reduce((t,s)=>s.active==!1?t+=1:t,0)*70*60,o=r.value.reduce((t,s)=>s.excavator_stop!=0?t+=s.excavator_stop:t,0);return isNaN(o/e)?0:Math.round(o/e*100)});return F(()=>{i()}),(n,e)=>(x(),g("section",{onMouseup:e[4]||(e[4]=o=>n.$emit("close")),class:"absolute inset-0 bg-black/40 z-[100] flex justify-center items-center p-10"},[a("main",{onMouseup:e[3]||(e[3]=L(()=>{},["stop"])),class:"bg-white w-full h-full rounded-md flex flex-col overflow-hidden relative"},[a("header",pe,[a("div",null,[a("button",{onClick:e[0]||(e[0]=o=>n.$emit("close")),class:"w-10 h-10 flex justify-center items-center active:bg-white/15 hover:bg-white/25"},xe)])]),a("main",ye,[a("div",be,[a("div",ge,[c(q,{day:m.value,"onUpdate:day":e[1]||(e[1]=o=>m.value=o),smena:d.value,"onUpdate:smena":e[2]||(e[2]=o=>d.value=o),onSubmit:i},null,8,["day","smena"])]),r.value.length?(x(),z(v(O),{key:0,"data-source":r.value,onExporting:v(I)},{"grid-cell":V(({data:o})=>[o.data.active?(x(),g("div",we,"В ремонте")):(x(),g("div",he,"В работе"))]),default:V(()=>[c(v(W),{enabled:!0,"allow-export-selected-data":!0}),c(v(y),{"data-field":"name",caption:"Техника",width:"120"}),c(v(y),{"data-field":"active",caption:"Статус","cell-template":"grid-cell"}),c(v(y),{"data-field":"counts",caption:"Кол-во зачищенных забоев",width:"200"}),c(v(y),{"data-field":"excavator_names",caption:"Экскаватор",width:"130"}),c(v(y),{"data-field":"in_smena",caption:"Доступное время в пересменку ЭКС",width:"260"}),c(v(y),{"data-field":"in_excavator",caption:"Время в геозоне ЭКС (мин)"}),c(v(y),{"data-field":"in_not_excavator_move",caption:"Вне геозоны ЭКС, в движении (мин)"}),c(v(y),{"data-field":"in_not_excavator_stop",caption:"Вне геозоны ЭКС, без движении (мин)"})]),_:1},8,["data-source","onExporting"])):C("",!0)]),a("div",$e,[U(" количество зачищенных забоев на 1 ед. работающей техники - "+M(p.value)+" ",1),ke,U(" Вне геозоны ЭКС, без движении % от доступного времени - "+M(l.value)+"% ",1)])])],32)],32))}}),Me={class:"flex justify-end items-center px-2 bg-slate-900 text-white"},Ce=a("i",{class:"fa-regular fa-xmark"},null,-1),ze=[Ce],Ve={class:"flex-grow relative"},Ye={class:"absolute inset-0 overflow-y-auto"},Se={class:"flex pt-2 px-2 items-start"},je={key:0,style:{color:"red"}},Te={key:1,style:{color:"green"}},Ne={class:"absolute bottom-0 w-full bg-gray-100 px-2 py-1.5 text-xl uppercase"},j=660,Ee=Y({__name:"GrayderModalSmena",setup(k){const b=f(),r=f([]),m=f(null),d=f(null);b.value=new P;const _=A();m.value=_.date,d.value=_.smena;async function i(){r.value=[];const l=w(m.value).format("YYYY-MM-DD"),n=d.value==1?{start:"08:30",end:"20:30"}:{start:"20:30",end:"08:30"},e=w(`${l} ${n.start}`).unix(),o=d.value==2?w(`${l} ${n.end}`).add(1,"days").unix():w(`${l} ${n.end}`).unix(),t=await b.value.greyderTable(10587,e,o);for(const u in t){const h=[...t[u].counts];var s="";h.forEach(S=>{s+=`${S.replace("РВ Экскаватор","")} `}),r.value.push({name:u,in_excavator:(t[u].time_in_excavator/60).toFixed(1),counts:t[u].counts.size,excavator_names:s,active:t[u].in_not_excavator_move==0&&t[u].in_not_excavator_stop==0&&t[u].time_in_excavator==0,in_smena:d.value==1?`08:30 - 20:30 | ${j} мин`:`20:30 - 08:30 | ${j} мин`,in_not_excavator_move:(t[u].in_not_excavator_move/60).toFixed(1),in_not_excavator_stop:(t[u].in_not_excavator_stop/60).toFixed(1),excavator_stop:Math.round((t[u].time_in_excavator+t[u].in_not_excavator_move)/(j*60)*100)+"%",excavator_move:t[u].in_not_excavator_move,time_in_excavator:t[u].time_in_excavator})}}const p=E(()=>{const l=r.value.reduce((t,s)=>s.active==!1?t+=1:t,0),n=r.value.reduce((t,s)=>s.time_in_excavator!=0?t+=s.time_in_excavator:t,0),e=r.value.reduce((t,s)=>s.excavator_move!=0?t+=s.excavator_move:t,0),o=l*j*60;return console.log(n,e,o),isNaN((n+e)/o*100)?0:Math.round((n+e)/o*100)});return F(()=>{i()}),(l,n)=>(x(),g("section",{onMouseup:n[4]||(n[4]=e=>l.$emit("close")),class:"absolute inset-0 bg-black/40 z-[100] flex justify-center items-center p-10"},[a("main",{onMouseup:n[3]||(n[3]=L(()=>{},["stop"])),class:"bg-white w-full h-full rounded-md flex flex-col overflow-hidden relative"},[a("header",Me,[a("div",null,[a("button",{onClick:n[0]||(n[0]=e=>l.$emit("close")),class:"w-10 h-10 flex justify-center items-center active:bg-white/15 hover:bg-white/25"},ze)])]),a("main",Ve,[a("div",Ye,[a("div",Se,[c(q,{day:m.value,"onUpdate:day":n[1]||(n[1]=e=>m.value=e),smena:d.value,"onUpdate:smena":n[2]||(n[2]=e=>d.value=e),onSubmit:i},null,8,["day","smena"])]),r.value.length?(x(),z(v(O),{key:0,"data-source":r.value,onExporting:v(I)},{"grid-cell":V(({data:e})=>[e.data.active?(x(),g("div",je,"В ремонте")):(x(),g("div",Te,"В работе"))]),default:V(()=>[c(v(W),{enabled:!0,"allow-export-selected-data":!0}),c(v(y),{"data-field":"name",caption:"Техника",width:"100"}),c(v(y),{"data-field":"active",caption:"Статус","cell-template":"grid-cell",width:"100"}),c(v(y),{"data-field":"counts",caption:"Кол-во зачищенных забоев",width:"200"}),c(v(y),{"data-field":"excavator_names",caption:"Экскаватор"}),c(v(y),{"data-field":"in_smena",caption:"Доступное время в пересменку ЭКС",width:"260"}),c(v(y),{"data-field":"in_excavator",caption:"Время в геозоне ЭКС (мин)"}),c(v(y),{"data-field":"in_not_excavator_move",caption:"Вне геозоны ЭКС, в движении (мин)"}),c(v(y),{"data-field":"in_not_excavator_stop",caption:"Вне геозоны ЭКС, без движении (мин)"}),c(v(y),{"data-field":"excavator_stop",caption:"Время в движении, % от доступного времени"})]),_:1},8,["data-source","onExporting"])):C("",!0)])]),a("div",Ne," Время в движении, % от доступного времени: "+M(p.value+"%"),1)],32)],32))}}),Ue="api/greyder-jobs";async function Fe(k){const{data:b}=await Z.post(`${Ue}/analyze`,k);return b}const Ge={analyze:Fe},Le={class:"flex justify-end items-center px-2 bg-slate-900 text-white"},Pe=a("i",{class:"fa-regular fa-xmark"},null,-1),Be=[Pe],Re={class:"flex-grow relative"},Je={class:"absolute inset-0 overflow-y-auto"},Ae={class:"p-2 flex justify-between items-start"},We={class:"table-auto"},Ie=a("thead",{class:"text-xl font-semibold"},"Анализ работы ДСМ",-1),Oe=a("tr",null,[a("td",null,"Смена"),a("td",null,"Кол-во зачищенных забоев"),a("td",null,"Среднее %, время вне движении")],-1),qe={class:"flex flex-col"},He={class:"mb-1.5"},Ke={for:"peresmenka"},Qe={for:"smenka"},Xe=Y({__name:"AnalyzeGreyderJobs",setup(k){const b=f([]),r=f(0),m=f({start:w("2025-01-15").toDate(),end:w("2025-01-25").toDate()}),d=E(()=>{const p={};return[...new Set(b.value.map(n=>n.teamNum).sort())].forEach(n=>{const o=b.value.filter(s=>s.teamNum==n).reduce((s,u)=>(s[u.day]?s[u.day].push(u):s[u.day]=[u],s),{}),t={};for(const s in o){const u=o[s],S=u.reduce((D,$)=>($.in_not_excavator_move==0&&$.in_not_excavator_stop==0&&$.time_in_excavator)==!1?D+=1:D,0)*70*60,B=u.reduce((D,$)=>$.in_not_excavator_stop!=0?D+=$.in_not_excavator_stop:D,0),H=u.reduce((D,$)=>$.counts[0]==""?D:D+=$.counts.length,0);t[s]={stop_prosent:isNaN(B/S)?0:Math.round(B/S*100),jobs:H}}p[n]=t}),p});function _(p){const l={counts:0,prosents:0};for(const n in p){const e=p[n];l.counts+=e.jobs,l.prosents+=e.stop_prosent}return l.prosents=Math.round(l.prosents/Object.keys(p).length),l}async function i(){b.value=await Ge.analyze({startDate:w(m.value.start).format("YYYY-MM-DD"),endDate:w(m.value.end).format("YYYY-MM-DD"),type:r.value})}return F(async()=>{i()}),(p,l)=>{const n=G("VDatePicker");return x(),g("section",{onMouseup:l[5]||(l[5]=e=>p.$emit("close")),class:"absolute inset-0 bg-black/40 z-[100] flex justify-center items-center p-10"},[a("main",{onMouseup:l[4]||(l[4]=L(()=>{},["stop"])),class:"bg-white w-[992px] h-full rounded-md flex flex-col overflow-hidden relative"},[a("header",Le,[a("div",null,[a("button",{onClick:l[0]||(l[0]=e=>p.$emit("close")),class:"w-10 h-10 flex justify-center items-center active:bg-white/15 hover:bg-white/25"},Be)])]),a("main",Re,[a("div",Je,[a("main",Ae,[a("div",null,[a("table",We,[Ie,Oe,(x(!0),g(ee,null,te(d.value,(e,o)=>(x(),g("tr",null,[a("td",null,M(o),1),a("td",null,M(_(e).counts),1),a("td",null,M(_(e).prosents)+"%",1)]))),256))])]),a("div",qe,[a("aside",He,[a("label",Ke,[T(a("input",{type:"radio",name:"smena",id:"peresmenka","onUpdate:modelValue":l[1]||(l[1]=e=>r.value=e),value:0},null,512),[[J,r.value]]),U(" Пересменка ")]),a("label",Qe,[T(a("input",{type:"radio",name:"smena",id:"smenka","onUpdate:modelValue":l[2]||(l[2]=e=>r.value=e),value:1},null,512),[[J,r.value]]),U(" Вся смена ")])]),c(n,{modelValue:m.value,"onUpdate:modelValue":[l[3]||(l[3]=e=>m.value=e),i],modelModifiers:{range:!0},mode:"date"},null,8,["modelValue"])])])])])],32)],32)}}}),Ze={class:"fixed inset-0"},et=a("i",{class:"fa-duotone fa-house"},null,-1),tt={class:"absolute bottom-3 left-0 p-2 z-50"},ut=Y({__name:"GreydersPage",setup(k){const b=f(),r=f(!1),m=f(!1),d=f(!1),_=oe(w()),i=ae({currentDate:_.date,wialon:null,geozones:null,leaflet:null,selected:null,loading:!1,smena:_.smena});function p(n){i.smena=n,l()}async function l(){i.loading=!0;const n=se(i.currentDate,i.smena),e=n.start,o=n.end;await i.wialon.greyderReport(e,o),i.loading=!1}return F(async()=>{i.leaflet=new le(b.value),i.wialon=new P(i.leaflet.map),i.wialon.onInit=()=>l()}),(n,e)=>{const o=G("RouterLink");return x(),g("section",Ze,[c(ie,{loading:i.loading},null,8,["loading"]),r.value?(x(),z(De,{key:0,onClose:e[0]||(e[0]=t=>r.value=!1)})):C("",!0),m.value?(x(),z(Ee,{key:1,onClose:e[1]||(e[1]=t=>m.value=!1)})):C("",!0),d.value?(x(),z(Xe,{key:2,onClose:e[2]||(e[2]=t=>d.value=!1)})):C("",!0),c(o,{to:"/",class:"absolute left-3 top-3 btn-line bg-white shadow-md !text-xl z-50 text-center content-center"},{default:V(()=>[et]),_:1}),a("div",tt,[T(a("input",{type:"date","onUpdate:modelValue":e[3]||(e[3]=t=>i.currentDate=t),onChange:l,class:"px-4 py-1.5 rounded-full shadow-sm"},null,544),[[ne,i.currentDate]]),a("button",{class:N([{"!bg-teal-600 !text-white":i.smena==1},"bg-white px-4 ml-2 py-1.5 rounded-full"]),onClick:e[4]||(e[4]=t=>p(1))},"1 Smena",2),a("button",{class:N([{"!bg-teal-600 !text-white":i.smena==2},"bg-white px-4 ml-2 py-1.5 rounded-full"]),onClick:e[5]||(e[5]=t=>p(2))},"2 Smena",2),a("button",{onClick:e[6]||(e[6]=t=>r.value=!0),class:"bg-white px-4 ml-2 py-1.5 rounded-full"},"Контроль зачистки забоя в пересменку"),a("button",{onClick:e[7]||(e[7]=t=>m.value=!0),class:"bg-white px-4 ml-2 py-1.5 rounded-full"},"Контроль зачистки забоя во время смены"),a("button",{onClick:e[8]||(e[8]=t=>d.value=!0),class:"bg-white px-4 ml-2 py-1.5 rounded-full"},"Анализ работы ДСМ")]),a("div",{ref_key:"geozonemap",ref:b,class:"h-full w-full z-40"},null,512)])}}});export{ut as default};
