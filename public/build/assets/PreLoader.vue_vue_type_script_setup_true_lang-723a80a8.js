import{u}from"./Wialon-91e93c25.js";import{d as f,o as p,p as _,w as v,c as w,y as k,T as C,a as y}from"./app-4370138c.js";class z{constructor(e,s=!1){this.points=[],this.pivotLat=42.32,this.pivotLon=63.82,this.size=50,this.store=u(),this.map=this.createMap(e),this.rectangles=[],s&&this.map.on("click",this.handleMapClick.bind(this))}handleMapClick(e){const s=e.latlng.lat,t=e.latlng.lng,a=Math.floor((this.pivotLat-s)*111e3/this.size),i=Math.floor((t-this.pivotLon)*(111e3*Math.cos(this.deg2rad(this.pivotLat)))/this.size);if(!this.rectangleFind(a,i))this.drawSquare({ZonaX:a,ZonaY:i},this.size,1);else{const{rectangle:n}=this.rectangleFind(a,i);n.remove(),this.rectangleDelete(a,i)}}rectangleFind(e,s){return this.rectangles.find(t=>t.row===e&&t.column===s)}rectanglesClear(){this.rectangles.forEach(({rectangle:e})=>{e.remove()}),this.rectangles=[]}rectangleDelete(e,s){const t=this.rectangles.findIndex(a=>a.row===e&&a.column===s);this.rectangles.splice(t,1)}getRectanglePoints(){return this.rectangles.map(e=>({ZonaX:e.row,ZonaY:e.column}))}createMap(e){const s=wialon.core.Session.getInstance().getId(),t=wialon.core.Session.getInstance(),a=L.map(e,{zoomControl:!1}).setView([42.2628699,63.891215],12);L.TileLayer.WebGis=L.TileLayer.extend({initialize:function(n,o){this._url=`http://wl.ngmk.uz/gis_render/{x}_{y}_{z}/${o.userId}/tile.png?sid=${s}`},getTileUrl:i}),new L.TileLayer.WebGis(t.getBaseGisUrl("render"),{attribution:"NKMK SHKB",minZoom:1,userId:t.getCurrUser().getId()}).addTo(a);function i(n){return L.Util.template(this._url,L.extend({s:this._getSubdomain(n),z:17-n.z,x:n.x,y:n.y},this.options))}return a}drawSquare(e,s,t,a=!1){const i=+e.ZonaX,n=+e.ZonaY,o=42.32,c=63.82,l=L.latLng(o-i*(s/111e3),c+n*(s/(111e3*Math.cos(this.deg2rad(o))))),h=L.latLng(o-(i+1)*(s/111e3),c+(n+1)*(s/(111e3*Math.cos(this.deg2rad(o))))),d=L.rectangle([l,h],{color:"red",weight:1,opacity:1,fillOpacity:.25}).addTo(this.map);this.rectangles.push({row:i,column:n,rectangle:d});const g=this.getCenterCubic(l,h);if(a){const m=L.marker(g,{icon:L.divIcon({className:"custom-marker-class",html:t})}).addTo(this.map);this.points.push({rect:d,marker:m}),this.store.points.push({center:g,item:e,image:m._icon,active:!1,index:t})}}getCenterCubic(e,s){const t=(e.lat+s.lat)/2,a=(e.lng+s.lng)/2;return L.latLng(t,a)}drawCubics(e){e.forEach((s,t)=>{this.drawSquare(s,50,t+1,!0)})}removeCubics(){this.points.forEach(e=>{this.map.removeLayer(e.rect),this.map.removeLayer(e.marker)}),this.store.points=[],this.points=[]}deg2rad(e){return e*(Math.PI/180)}fixedToPoint(e,s){this.store.points.forEach(t=>{t.image==s?(t.active=!0,t.image.classList.add("animate-marker")):(t.active=!1,t.image.classList.remove("animate-marker"))}),this.map.setView(e,15)}}const b={key:0,class:"bg-black/30 absolute inset-0 z-[100] flex justify-center items-center"},x=y("span",{class:"loader"},null,-1),M=[x],S=f({__name:"PreLoader",props:["loading"],setup(r){const e=r;return(s,t)=>(p(),_(C,null,{default:v(()=>[e.loading?(p(),w("div",b,M)):k("",!0)]),_:1}))}});export{z as L,S as _};
