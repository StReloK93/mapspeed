var f=Object.defineProperty;var _=(o,e,t)=>e in o?f(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>(_(o,typeof e!="symbol"?e+"":e,t),t);import{u as v}from"./Wialon-a9adff1e.js";import{d as w,o as u,p as k,w as C,c as y,y as b,T as x,a as M}from"./app-f3ee025b.js";class E{constructor(e,t=!1){r(this,"map");r(this,"store");r(this,"points",[]);r(this,"pivotLat");r(this,"pivotLon");r(this,"size");r(this,"rectangles");this.pivotLat=42.32,this.pivotLon=63.82,this.size=50,this.store=v(),this.map=this.createMap(e),this.rectangles=[],t&&this.map.on("click",this.handleMapClick.bind(this))}handleMapClick(e){const t=e.latlng.lat,s=e.latlng.lng,a=Math.floor((this.pivotLat-t)*111e3/this.size),i=Math.floor((s-this.pivotLon)*(111e3*Math.cos(this.deg2rad(this.pivotLat)))/this.size);if(!this.rectangleFind(a,i))this.drawSquare({ZonaX:a,ZonaY:i},this.size,1);else{const{rectangle:n}=this.rectangleFind(a,i);n.remove(),this.rectangleDelete(a,i)}}rectangleFind(e,t){return this.rectangles.find(s=>s.row===e&&s.column===t)}rectanglesClear(){this.rectangles.forEach(({rectangle:e})=>{e.remove()}),this.rectangles=[]}rectangleDelete(e,t){const s=this.rectangles.findIndex(a=>a.row===e&&a.column===t);this.rectangles.splice(s,1)}getRectanglePoints(){return this.rectangles.map(e=>({ZonaX:e.row,ZonaY:e.column}))}createMap(e){const t=wialon.core.Session.getInstance().getId(),s=wialon.core.Session.getInstance(),a=L.map(e,{zoomControl:!1}).setView([42.2628699,63.891215],12);L.TileLayer.WebGis=L.TileLayer.extend({initialize:function(n,c){this._url=`http://wl.ngmk.uz/gis_render/{x}_{y}_{z}/${c.userId}/tile.png?sid=${t}`},getTileUrl:i}),new L.TileLayer.WebGis(s.getBaseGisUrl("render"),{attribution:"NKMK SHKB",minZoom:1,userId:s.getCurrUser().getId()}).addTo(a);function i(n){return L.Util.template(this._url,L.extend({s:this._getSubdomain(n),z:17-n.z,x:n.x,y:n.y},this.options))}return a}drawSquare(e,t,s,a=!1){const i=+e.ZonaX,n=+e.ZonaY,c=42.32,l=63.82,h=L.latLng(c-i*(t/111e3),l+n*(t/(111e3*Math.cos(this.deg2rad(c))))),d=L.latLng(c-(i+1)*(t/111e3),l+(n+1)*(t/(111e3*Math.cos(this.deg2rad(c))))),g=L.rectangle([h,d],{color:"red",weight:1,opacity:1,fillOpacity:.25}).addTo(this.map);this.rectangles.push({row:i,column:n,rectangle:g});const m=this.getCenterCubic(h,d);if(a){const p=L.marker(m,{icon:L.divIcon({className:"custom-marker-class",html:s})}).addTo(this.map);this.points.push({rect:g,marker:p}),this.store.points.push({center:m,item:e,image:p._icon,active:!1,index:s})}}getCenterCubic(e,t){const s=(e.lat+t.lat)/2,a=(e.lng+t.lng)/2;return L.latLng(s,a)}drawCubics(e){e.forEach((t,s)=>{this.drawSquare(t,50,s+1,!0)})}removeCubics(){this.points.forEach(e=>{this.map.removeLayer(e.rect),this.map.removeLayer(e.marker)}),this.store.points=[],this.points=[]}deg2rad(e){return e*(Math.PI/180)}fixedToPoint(e,t){this.store.points.forEach(s=>{s.image==t?(s.active=!0,s.image.classList.add("animate-marker")):(s.active=!1,s.image.classList.remove("animate-marker"))}),this.map.setView(e,15)}}const T={key:0,class:"bg-black/30 absolute inset-0 z-[100] flex justify-center items-center"},z=M("span",{class:"loader"},null,-1),I=[z],N=w({__name:"PreLoader",props:["loading"],setup(o){const e=o;return(t,s)=>(u(),k(x,null,{default:C(()=>[e.loading?(u(),y("div",T,I)):b("",!0)]),_:1}))}});export{E as L,N as _};
