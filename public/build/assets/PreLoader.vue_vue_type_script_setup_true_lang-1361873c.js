var f=Object.defineProperty;var v=(o,e,t)=>e in o?f(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var c=(o,e,t)=>(v(o,typeof e!="symbol"?e+"":e,t),t);import{u as w}from"./Wialon-127f7356.js";import{d as _,b as y,w as S,V as T,o as m,c as k,e as P,a as I}from"./app-736814d1.js";class N{constructor(e,t=0){c(this,"map");c(this,"store");c(this,"points",[]);c(this,"drawPoints",[]);c(this,"pivotLat");c(this,"pivotLon");c(this,"size");c(this,"rectangles");c(this,"selectedCircle");c(this,"onSelectCircle");c(this,"onClearSelectCircle");if(ENV.PIVOT_LAT==null||ENV.PIVOT_LAT==null){console.error("ENV ga PIVOT_LAT va PIVOT_LAT qiymatlar kiritilmagan");return}this.pivotLat=ENV.PIVOT_LAT,this.pivotLon=ENV.PIVOT_LON,this.size=50,this.store=w(),this.map=this.createMap(e),this.rectangles=[],this.drawPoints=[],t==1&&this.map.on("click",this.handleMapClick.bind(this)),t==2&&this.writeLine(this.map)}handleMapClick(e){if(e.originalEvent.ctrlKey){const t=Math.floor((this.pivotLat-e.latlng.lat)*111e3/this.size),i=Math.floor((this.pivotLon-e.latlng.lng)*(111e3*Math.cos(this.deg2rad(this.pivotLat)))/this.size);if(console.log(t,i),!this.rectangleFind(t,i))this.drawSquare({ZonaX:t,ZonaY:i,color:"red"},this.size,1);else{const{rectangle:s}=this.rectangleFind(t,i);s.remove(),this.rectangleDelete(t,i)}}}drawSquare(e,t,i,s=!1){const l=e.ZonaX!==void 0?+e.ZonaX:e.x,r=e.ZonaY!==void 0?+e.ZonaY:e.y,n=this.pivotLat,a=this.pivotLon,h=Math.cos(this.deg2rad(n)),d=L.latLng(n-l*(t/111e3),a-r*(t/(111e3*h))),g=L.latLng(n-(l+1)*(t/111e3),a-(r+1)*(t/(111e3*h))),p=L.rectangle([d,g],{color:e.color,weight:1,opacity:1,fillOpacity:.25}).addTo(this.map);this.rectangles.push({row:l,column:r,rectangle:p,color:e.color});const C=this.getCenterCubic(d,g);if(s){const u=L.marker(C,{icon:L.divIcon({className:"custom-marker-class",html:i})}).addTo(this.map);this.points.push({rect:p,marker:u}),this.store.points.push({center:C,item:e,image:u._icon,active:!1,index:i})}}geetDrawPoints(){return this.drawPoints.map((e,t)=>({index:t,lat:e.point[0],lng:e.point[1],color:e.color}))}writeLine(e){e.on("click",s=>{const l=[s.latlng.lat,s.latlng.lng];s.originalEvent.target.classList.contains("circle")||(this.selectedCircle?t(l):i(l))});const t=s=>{this.selectedCircle.circle.setLatLng(s),this.selectedCircle.point=s,this.selectedCircle.circle.setStyle({color:this.selectedCircle.color}),this.selectedCircle.line&&this.selectedCircle.line.setStyle({color:this.selectedCircle.color}),this.reDrawLines(),this.onClearSelectCircle&&this.onClearSelectCircle(),this.selectedCircle=null},i=s=>{const l=this.createCircle(s);if(this.drawPoints.length>0)var r=L.polyline([this.drawPoints.at(-1).point,s],{color:"red",weight:2,interactive:!1}).addTo(e);this.drawPoints.push({point:s,circle:l,line:r,color:"red"})}}createCircle(e,t="red"){const i=L.circle(e,{radius:10,weight:1,color:t}).addTo(this.map);return i._path.classList.add("circle"),i.on("click",()=>{this.selectedCircle&&(this.selectedCircle.circle.setStyle({color:this.selectedCircle.color}),this.selectedCircle.line&&this.selectedCircle.line.setStyle({color:this.selectedCircle.color})),this.selectedCircle=this.drawPoints.find(s=>s.circle._leaflet_id==i._leaflet_id),this.selectedCircle.circle.setStyle({color:"blue"}),this.selectedCircle.line&&this.selectedCircle.line.setStyle({color:"blue"}),this.onSelectCircle&&this.onSelectCircle()}),i}changeColorDrawLine(e){this.selectedCircle&&(this.selectedCircle.line&&this.selectedCircle.line.setStyle({color:e}),this.selectedCircle.circle.setStyle({color:e}),this.selectedCircle.color=e,this.selectedCircle=null,this.onClearSelectCircle())}clearDrawLinePoints(){this.drawPoints.forEach(e=>{e.circle.remove(),e.line&&e.line.remove()}),this.drawPoints=[]}deleteDrawLine(){if(this.selectedCircle){const e=this.drawPoints.findIndex(i=>i.circle==this.selectedCircle.circle),t=this.drawPoints.find(i=>i.circle==this.selectedCircle.circle);e==0?(t.circle.remove(),this.drawPoints[1].line.remove(),this.drawPoints.splice(e,1),this.reDrawLines(),this.onClearSelectCircle()):e>0&&(t.circle.remove(),t.line.remove(),this.drawPoints.splice(e,1),this.reDrawLines(),this.onClearSelectCircle())}}reDrawLines(){this.drawPoints.find((e,t)=>{if(t!=0){e.line.remove();const s=this.drawPoints[t-1].point;var i=L.polyline([s,e.point],{color:e.color,weight:2,interactive:!1}).addTo(this.map);e.line=i}})}reDrawLinesBase(e){e.forEach((t,i)=>{const s=[t.lat,t.lng],l=this.createCircle([t.lat,t.lng],t.color);if(i==0)this.drawPoints.push({point:s,circle:l,line:null,color:t.color});else{const n=[e[i-1].lat,e[i-1].lng];var r=L.polyline([n,s],{color:t.color,weight:2,interactive:!1}).addTo(this.map);this.drawPoints.push({point:s,circle:l,line:r,color:t.color})}})}rectangleFind(e,t){return this.rectangles.find(i=>i.row===e&&i.column===t)}rectanglesClear(){this.rectangles.forEach(({rectangle:e})=>{e.remove()}),this.rectangles=[]}rectangleDelete(e,t){const i=this.rectangles.findIndex(s=>s.row===e&&s.column===t);this.rectangles.splice(i,1)}getRectanglePoints(){return this.rectangles.map(e=>({ZonaX:e.row,ZonaY:e.column,color:e.color}))}createMap(e){const t=wialon.core.Session.getInstance().getId(),i=wialon.core.Session.getInstance(),s=L.map(e,{zoomControl:!1}).setView([this.pivotLat,this.pivotLon],12);L.TileLayer.WebGis=L.TileLayer.extend({initialize:function(r,n){this._url=`http://wl.ngmk.uz/gis_render/{x}_{y}_{z}/${n.userId}/tile.png?sid=${t}`},getTileUrl:l}),new L.TileLayer.WebGis(i.getBaseGisUrl("render"),{attribution:"NKMK SHKB",minZoom:1,userId:i.getCurrUser().getId()}).addTo(s);function l(r){return L.Util.template(this._url,L.extend({s:this._getSubdomain(r),z:17-r.z,x:r.x,y:r.y},this.options))}return s}getCenterCubic(e,t){const i=(e.lat+t.lat)/2,s=(e.lng+t.lng)/2;return L.latLng(i,s)}drawCubics(e,t=!0){e.forEach((i,s)=>{this.drawSquare(i,this.size,s+1,t)})}removeCubics(){this.points.forEach(e=>{this.map.removeLayer(e.rect),this.map.removeLayer(e.marker)}),this.store.points=[],this.points=[]}deg2rad(e){return e*(Math.PI/180)}fixedToPoint(e,t){this.store.points.forEach(i=>{i.image==t?(i.active=!0,i.image.classList.add("animate-marker")):(i.active=!1,i.image.classList.remove("animate-marker"))}),this.map.setView(e,15)}}const V={key:0,class:"bg-black/30 absolute inset-0 z-[100] flex justify-center items-center"},b=I("span",{class:"loader"},null,-1),E=[b],M=_({__name:"PreLoader",props:["loading"],setup(o){const e=o;return(t,i)=>(m(),y(T,null,{default:S(()=>[e.loading?(m(),k("div",V,E)):P("",!0)]),_:1}))}});export{N as L,M as _};
