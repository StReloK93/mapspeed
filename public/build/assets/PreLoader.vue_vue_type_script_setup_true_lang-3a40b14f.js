var f=Object.defineProperty;var _=(i,t,e)=>t in i?f(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var n=(i,t,e)=>(_(i,typeof t!="symbol"?t+"":t,e),e);import{u as v}from"./Wialon-e53a39fc.js";import{d as T,o as m,p as w,w as k,c as y,y as I,T as V,a as C}from"./app-5ad52092.js";class Z{constructor(t,e=!1){n(this,"map");n(this,"store");n(this,"points",[]);n(this,"pivotLat");n(this,"pivotLon");n(this,"size");n(this,"rectangles");if(ENV.PIVOT_LAT==null||ENV.PIVOT_LAT==null){console.error("ENV ga PIVOT_LAT va PIVOT_LAT qiymatlar kiritilmagan");return}this.pivotLat=ENV.PIVOT_LAT,this.pivotLon=ENV.PIVOT_LON,this.size=50,this.store=v(),this.map=this.createMap(t),this.rectangles=[],e&&this.map.on("click",this.handleMapClick.bind(this))}handleMapClick(t){if(t.originalEvent.ctrlKey){const e=Math.floor((this.pivotLat-t.latlng.lat)*111e3/this.size),s=Math.floor((t.latlng.lng-this.pivotLon)*(111e3*Math.cos(this.deg2rad(this.pivotLat)))/this.size);if(!this.rectangleFind(e,s))this.drawSquare({ZonaX:e,ZonaY:s,color:"red"},this.size,1);else{const{rectangle:a}=this.rectangleFind(e,s);a.remove(),this.rectangleDelete(e,s)}}}rectangleFind(t,e){return this.rectangles.find(s=>s.row===t&&s.column===e)}rectanglesClear(){this.rectangles.forEach(({rectangle:t})=>{t.remove()}),this.rectangles=[]}rectangleDelete(t,e){const s=this.rectangles.findIndex(a=>a.row===t&&a.column===e);this.rectangles.splice(s,1)}getRectanglePoints(){return this.rectangles.map(t=>({ZonaX:t.row,ZonaY:t.column,color:t.color}))}createMap(t){const e=wialon.core.Session.getInstance().getId(),s=wialon.core.Session.getInstance(),a=L.map(t,{zoomControl:!1}).setView([this.pivotLat,this.pivotLon],12);L.TileLayer.WebGis=L.TileLayer.extend({initialize:function(o,r){this._url=`http://wl.ngmk.uz/gis_render/{x}_{y}_{z}/${r.userId}/tile.png?sid=${e}`},getTileUrl:c}),new L.TileLayer.WebGis(s.getBaseGisUrl("render"),{attribution:"NKMK SHKB",minZoom:1,userId:s.getCurrUser().getId()}).addTo(a);function c(o){return L.Util.template(this._url,L.extend({s:this._getSubdomain(o),z:17-o.z,x:o.x,y:o.y},this.options))}return a}drawSquare(t,e,s,a=!1){const c=t.ZonaX!==void 0?t.ZonaX:t.x,o=t.ZonaY!==void 0?t.ZonaY:t.y,r=this.pivotLat,l=this.pivotLon,h=L.latLng(r-c*(e/111e3),l+o*(e/(111e3*Math.cos(this.deg2rad(r))))),d=L.latLng(r-(c+1)*(e/111e3),l+(o+1)*(e/(111e3*Math.cos(this.deg2rad(r))))),g=L.rectangle([h,d],{color:t.color,weight:1,opacity:1,fillOpacity:.25}).addTo(this.map);this.rectangles.push({row:c,column:o,rectangle:g,color:t.color});const p=this.getCenterCubic(h,d);if(a){const u=L.marker(p,{icon:L.divIcon({className:"custom-marker-class",html:s})}).addTo(this.map);this.points.push({rect:g,marker:u}),this.store.points.push({center:p,item:t,image:u._icon,active:!1,index:s})}}getCenterCubic(t,e){const s=(t.lat+e.lat)/2,a=(t.lng+e.lng)/2;return L.latLng(s,a)}drawCubics(t,e=!0){t.forEach((s,a)=>{this.drawSquare(s,this.size,a+1,e)})}removeCubics(){this.points.forEach(t=>{this.map.removeLayer(t.rect),this.map.removeLayer(t.marker)}),this.store.points=[],this.points=[]}deg2rad(t){return t*(Math.PI/180)}fixedToPoint(t,e){this.store.points.forEach(s=>{s.image==e?(s.active=!0,s.image.classList.add("animate-marker")):(s.active=!1,s.image.classList.remove("animate-marker"))}),this.map.setView(t,15)}}const x={key:0,class:"bg-black/30 absolute inset-0 z-[100] flex justify-center items-center"},b=C("span",{class:"loader"},null,-1),E=[b],O=T({__name:"PreLoader",props:["loading"],setup(i){const t=i;return(e,s)=>(m(),w(V,null,{default:k(()=>[t.loading?(m(),y("div",x,E)):I("",!0)]),_:1}))}});export{Z as L,O as _};
